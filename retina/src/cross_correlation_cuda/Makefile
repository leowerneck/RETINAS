# Library generated by this Makefile
LIBNAME = libretina_cuda.so

# Library directory path
LIB_DIR = ../../../lib

# Specify the CUDA and C++ compilers
NVCC = /usr/local/cuda-11.7/bin/nvcc
CXX  = g++

# Specify compilation flags.
NVCCFLAGS = -O3 -Xptxas -O3 -Xcompiler -fPIC -allow-unsupported-compiler -gencode arch=compute_50,code=compute_50
CXXFLAGS  = -O3 -march=native -Wall -shared -fPIC

# Specify the library flags
LDFLAGS = -lm -L/usr/local/cuda-11.7/lib64 -lcuda -lcufft -lcublas -lcudart

# Source code files in the project
SRC := $(wildcard *.cu)

# Header files in the project
INC := $(wildcard *.h)

# Target library name
LIB     = $(LIB_DIR)/$(LIBNAME)

SRC_DIR := $(notdir $(shell pwd))
OBJ_DIR := $(addprefix ../../../build/, $(SRC_DIR))

# Get every file defined in SRC and replace '.cu' by '.o'
OBJ := $(addprefix $(OBJ_DIR)/, $(SRC:.cu=.o))

all: $(LIB_DIR) $(OBJ_DIR) $(LIB)

$(LIB_DIR):
	@echo "Creating directory lib/"
	@mkdir -p $@

$(OBJ_DIR):
	@echo "Creating directory build/$(SRC_DIR)"
	@mkdir -p $@

$(LIB): $(OBJ)
	@echo "Creating library file lib/$(LIBNAME)"
	@$(CXX) $(CXXFLAGS) $(OBJ) -o $(LIB) $(LDFLAGS)

$(OBJ): $(OBJ_DIR)/%.o : %.cu $(INC)
	@echo "Compiling file $(SRC_DIR)/$<"
	@$(NVCC) $(NVCCFLAGS) -c $< -o $@

clean:
	@echo "Removing object and library files for $(SRC_DIR)"
	@rm -f $(OBJ) $(LIB)
